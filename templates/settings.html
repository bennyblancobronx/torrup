<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}" />
  <title>{{ app_name }} Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <script>
    (function() {
      const pref = localStorage.getItem('theme') || 'system';
      if (pref === 'system') {
        const sys = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', sys);
      } else {
        document.documentElement.setAttribute('data-theme', pref);
      }
    })();
  </script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-brand">
      <a href="/" class="header-logo">{{ app_name }}</a>
      <a href="/changelog" class="header-version">v{{ app_version }}</a>
    </div>
    <nav class="header-nav">
      <a href="/" class="nav-item">Dashboard</a>
      <a href="/browse" class="nav-item">Browse</a>
      <a href="/queue" class="nav-item">Queue</a>
      <a href="/history" class="nav-item">History</a>
      <a href="/settings" class="nav-item nav-item-settings is-active" title="Settings"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container page">
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>

    <!-- General -->
    <div class="card mb-6">
      <h2 class="section-title">General</h2>
      <div class="form-group">
        <label class="form-label">Output Dir</label>
        <div class="path-input-group">
          <input id="output_dir" value="{{ settings['output_dir'] }}" />
          <button class="btn btn-secondary btn-sm" type="button" onclick="openDirPicker('output_dir')">Browse</button>
        </div>
        <div class="form-hint">Where .torrent, .nfo, and .xml sidecars are written.</div>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="form-label">Release Group</label>
          <input id="release_group" value="{{ settings.get('release_group', 'torrup') }}" />
          <div class="form-hint">Your release group name for NFO files and naming.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Exclude Folders (comma-separated)</label>
          <input id="exclude_dirs" value="{{ settings['exclude_dirs'] }}" />
          <div class="form-hint">Folders containing these names are hidden from browse.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Theme</label>
          <select id="theme_setting">
            <option value="system">System Default</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <div class="form-hint">Choose light, dark, or follow your system preference.</div>
        </div>
      </div>
    </div>

    <!-- Automation -->
    <div class="card mb-6">
      <h2 class="section-title">Automation (Beta)</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="test_mode" {% if settings.get('test_mode', '0') == '1' %}checked{% endif %} />
            Test Mode (Dry Run)
          </label>
          <div class="form-hint">Generate NFO + torrent but skip the actual upload to TorrentLeech.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="enable_auto_upload" {% if settings.get('enable_auto_upload', '0') == '1' %}checked{% endif %} />
            Enable Auto-Scan + Upload
          </label>
          <div class="form-hint">Automatically scan roots and queue items missing from TorrentLeech.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Scan Interval (minutes)</label>
          <input type="number" id="auto_scan_interval" value="{{ settings.get('auto_scan_interval', '60') }}" />
        </div>
      </div>
    </div>

    <!-- Media Roots -->
    <div class="card mb-6">
      <h2 class="section-title">Media Roots + Defaults</h2>
      <table class="table" id="media-roots">
        <thead>
          <tr>
            <th>Media Type</th>
            <th>Enabled</th>
            <th>Auto Scan</th>
            <th>Path</th>
            <th>Default Category</th>
          </tr>
        </thead>
        <tbody>
          {% for r in media_roots %}
          {% set unsupported = r.media_type != 'music' %}
          <tr {% if unsupported %}style="opacity: 0.4; pointer-events: none;"{% endif %} data-media-type="{{ r.media_type }}">
            <td>{{ r.media_type }}{% if unsupported %} <span class="text-muted text-sm">(coming soon)</span>{% endif %}</td>
            <td><input type="checkbox" data-field="enabled" {% if r.enabled %}checked{% endif %} {% if unsupported %}disabled{% endif %} style="width: auto; height: auto;" /></td>
            <td><input type="checkbox" data-field="auto_scan" {% if r.auto_scan %}checked{% endif %} {% if unsupported %}disabled{% endif %} style="width: auto; height: auto;" /></td>
            <td>
              <div class="path-input-group">
                <input data-field="path" value="{{ r.path }}" {% if unsupported %}disabled{% endif %} />
                <button class="btn btn-secondary btn-sm" type="button" onclick="openDirPickerForRow(this)" {% if unsupported %}disabled{% endif %}>Browse</button>
              </div>
            </td>
            <td>
              <select data-field="default_category" {% if unsupported %}disabled{% endif %}>
                {% for opt in category_options[r.media_type] %}
                <option value="{{ opt.id }}" {% if opt.id == r.default_category %}selected{% endif %}>{{ opt.label }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-hint mt-2">Auto-scan only processes items in roots that are enabled and have "Auto Scan" checked.</div>
    </div>

    <!-- Metadata Extraction -->
    <div class="card mb-6">
      <h2 class="section-title">Metadata Extraction</h2>
      <div class="grid grid-cols-2 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="extract_metadata" {% if settings.get('extract_metadata', '1') == '1' %}checked{% endif %} />
            Extract Metadata (exiftool)
          </label>
          <div class="form-hint">Extract title, artist, album, year from files.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="extract_thumbnails" {% if settings.get('extract_thumbnails', '1') == '1' %}checked{% endif %} />
            Extract Thumbnails (ffmpeg)
          </label>
          <div class="form-hint">Extract video thumbnails and album artwork.</div>
        </div>
      </div>
    </div>

    <!-- qBitTorrent Integration -->
    <div class="card mb-6">
      <h2 class="section-title">qBitTorrent Integration</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="qbt_enabled" {% if settings.get('qbt_enabled', '0') == '1' %}checked{% endif %} />
            Enable qBitTorrent
          </label>
          <div class="form-hint">Auto-seed uploads via qBitTorrent after successful TL upload.</div>
        </div>
        <div class="form-group">
          <label class="form-label">qBT URL</label>
          <input id="qbt_url" value="{{ settings.get('qbt_url', 'http://localhost:8080') }}" />
        </div>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="qbt_user" value="{{ settings.get('qbt_user', 'admin') }}" />
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="qbt_pass" value="{{ settings.get('qbt_pass', 'adminadmin') }}" />
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button class="btn btn-secondary btn-sm" id="test-qbt">Test Connection</button>
        <span class="text-muted text-sm" id="qbt-test-status"></span>
      </div>
    </div>

    <!-- Naming Templates -->
    <div class="card mb-6">
      <h2 class="section-title">Naming Templates</h2>
      <div class="grid grid-cols-2 gap-6">
        {% for key, tpl in templates.items() %}
        <div class="form-group">
          <label class="form-label">{{ key }}</label>
          <input data-template="{{ key }}" value="{{ tpl }}" />
        </div>
        {% endfor %}
      </div>
      <div class="form-hint">Templates are guidance only; you can edit per item in the queue.</div>
    </div>

    <!-- TorrentLeech Preferences -->
    <div class="card mb-6">
      <h2 class="section-title">TorrentLeech Preferences</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="form-label">Minimum Uploads (per month)</label>
          <input type="number" id="tl_min_uploads_per_month" min="0" max="100" value="{{ settings.get('tl_min_uploads_per_month', '10') }}" />
          <div class="form-hint">Expected minimum uploads per month for TL activity rules.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Minimum Seed Copies</label>
          <input type="number" id="tl_min_seed_copies" min="0" max="100" value="{{ settings.get('tl_min_seed_copies', '10') }}" />
          <div class="form-hint">Seed until 10 copies exist, unless the week minimum is met first.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Minimum Seed Days</label>
          <input type="number" id="tl_min_seed_days" min="0" max="100" value="{{ settings.get('tl_min_seed_days', '7') }}" />
          <div class="form-hint">Seed for at least 7 days, unless the copy minimum is met first.</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="form-label">Inactivity Warning (weeks)</label>
          <input type="number" id="tl_inactivity_warning_weeks" min="0" max="100" value="{{ settings.get('tl_inactivity_warning_weeks', '3') }}" />
          <div class="form-hint">TL mentions warnings after a few weeks of inactivity.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Absence Notice (weeks)</label>
          <input type="number" id="tl_absence_notice_weeks" min="0" max="100" value="{{ settings.get('tl_absence_notice_weeks', '4') }}" />
          <div class="form-hint">Notify if you expect to be away 4+ weeks.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="tl_enforce_activity" {% if settings.get('tl_enforce_activity', '1') == '1' %}checked{% endif %} />
            Enforce Activity Minimums
          </label>
          <div class="form-hint">Use these minimums when planning queue targets.</div>
        </div>
      </div>
    </div>

    <!-- ntfy Notifications -->
    <div class="card mb-6">
      <h2 class="section-title">Push Notifications (ntfy)</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="ntfy_enabled" {% if settings.get('ntfy_enabled', '0') == '1' %}checked{% endif %} />
            Enable ntfy Notifications
          </label>
          <div class="form-hint">Send push alerts when activity drops below the minimum.</div>
        </div>
        <div class="form-group">
          <label class="form-label">ntfy Server URL</label>
          <input id="ntfy_url" value="{{ settings.get('ntfy_url', '') }}" placeholder="https://ntfy.sh" />
          <div class="form-hint">URL of your ntfy server (e.g. https://ntfy.sh).</div>
        </div>
        <div class="form-group">
          <label class="form-label">ntfy Topic</label>
          <input id="ntfy_topic" value="{{ settings.get('ntfy_topic', '') }}" placeholder="torrup-alerts" />
          <div class="form-hint">Topic name for notifications.</div>
        </div>
      </div>
    </div>

    <!-- Save -->
    <div class="card mb-6">
      <div class="flex items-center gap-4">
        <button class="btn btn-primary btn-md" id="save">Save Settings</button>
        <span class="text-muted text-sm" id="status"></span>
      </div>
    </div>
  </main>

  <!-- Directory Picker Modal -->
  <div class="modal-backdrop hidden" id="dir-picker-backdrop" onclick="closeDirPicker()"></div>
  <div class="modal modal-md hidden" id="dir-picker-modal">
    <div class="modal-header">
      <h3 class="modal-title">Choose Directory</h3>
      <button class="modal-close" onclick="closeDirPicker()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="dir-current-path" id="dir-current-path">/</div>
      <ul class="dir-list" id="dir-list"></ul>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary btn-sm" onclick="closeDirPicker()">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="selectDir()">Select This Directory</button>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
</body>
</html>
