<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}" />
  <title>{{ app_name }} Settings</title>
  <style>
    :root {
      --bg: #0f0f12; --bg-panel: #15151b; --bg-input: #1e1e27;
      --border: #242430; --border-light: #2d2d3a;
      --text: #e9e9ef; --text-muted: #9aa0a6; --text-heading: #c2c2d1;
      --accent: #8be9fd;
    }
    [data-theme="light"] {
      --bg: #f5f5f7; --bg-panel: #ffffff; --bg-input: #f0f0f2;
      --border: #d0d0d8; --border-light: #c5c5cd;
      --text: #1a1a1a; --text-muted: #666670; --text-heading: #333340;
      --accent: #0077cc;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Iosevka", "IBM Plex Sans", "Segoe UI", sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }
    a { color: var(--accent); text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { font-size: 1.6rem; margin-bottom: 6px; }
    .sub { color: var(--text-muted); margin-bottom: 18px; }
    .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .panel h2 { font-size: 1.05rem; margin-bottom: 12px; color: var(--text-heading); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 260px; }
    .field { margin-bottom: 12px; }
    label { display: block; margin-bottom: 6px; color: var(--text-muted); }
    input, textarea, select, button {
      background: var(--bg-input); color: var(--text); border: 1px solid var(--border-light); border-radius: 6px;
      padding: 8px 10px; font-size: 0.95rem; width: 100%;
    }
    textarea { min-height: 90px; }
    button { cursor: pointer; font-weight: 600; width: auto; }
    button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
    .muted { color: var(--text-muted); font-size: 0.85rem; }
    .actions { display: flex; gap: 10px; align-items: center; }
    .theme-toggle { cursor: pointer; background: none; border: none; padding: 4px 8px; width: auto; display: flex; align-items: center; }
  </style>
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>{{ app_name }} Settings</h1>
        <div class="sub">v{{ app_version }} â€” Everything is editable here</div>
      </div>
      <div class="actions">
        <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
        <a href="/">Back to app</a>
      </div>
    </div>

    <div class="panel">
      <h2>General</h2>
      <div class="row">
        <div class="col">
          <div class="field">
            <label>Browse Base</label>
            <input id="browse_base" value="{{ settings['browse_base'] }}" />
            <div class="muted">Default base path for your clean library.</div>
          </div>
        </div>
        <div class="col">
          <div class="field">
            <label>Output Dir</label>
            <input id="output_dir" value="{{ settings['output_dir'] }}" />
            <div class="muted">Where .torrent, .nfo, and .xml sidecars are written.</div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="field">
            <label>Release Group</label>
            <input id="release_group" value="{{ settings.get('release_group', 'Torrup') }}" />
            <div class="muted">Your release group name for NFO files and naming.</div>
          </div>
        </div>
        <div class="col">
          <div class="field">
            <label>Exclude Folders (comma-separated)</label>
            <input id="exclude_dirs" value="{{ settings['exclude_dirs'] }}" />
            <div class="muted">Folders containing these names are hidden from browse.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Automation (Beta)</h2>
      <div class="row">
        <div class="col">
          <div class="field">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="enable_auto_upload" style="width: auto;" {% if settings.get('enable_auto_upload', '0') == '1' %}checked{% endif %} />
              Enable Auto-Scan + Upload
            </label>
            <div class="muted">Automatically scan roots and queue items missing from TorrentLeech.</div>
          </div>
        </div>
        <div class="col">
          <div class="field">
            <label>Scan Interval (minutes)</label>
            <input type="number" id="auto_scan_interval" value="{{ settings.get('auto_scan_interval', '60') }}" />
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Media Roots + Defaults</h2>
      <table id="media-roots">
        <thead>
          <tr>
            <th>Media Type</th>
            <th>Enabled</th>
            <th>Auto Scan</th>
            <th>Path</th>
            <th>Default Category</th>
          </tr>
        </thead>
        <tbody>
          {% for r in media_roots %}
          <tr>
            <td>{{ r.media_type }}</td>
            <td><input type="checkbox" data-field="enabled" {% if r.enabled %}checked{% endif %} /></td>
            <td><input type="checkbox" data-field="auto_scan" {% if r.auto_scan %}checked{% endif %} /></td>
            <td><input data-field="path" value="{{ r.path }}" /></td>
            <td>
              <select data-field="default_category">
                {% for opt in category_options[r.media_type] %}
                <option value="{{ opt.id }}" {% if opt.id == r.default_category %}selected{% endif %}>{{ opt.label }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted" style="margin-top: 8px;">Auto-scan only processes items in roots that are enabled and have "Auto Scan" checked.</div>
    </div>

    <div class="panel">
      <h2>Metadata Extraction</h2>
      <div class="row">
        <div class="col">
          <div class="field">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="extract_metadata" style="width: auto;" {% if settings.get('extract_metadata', '1') == '1' %}checked{% endif %} />
              Extract Metadata (exiftool)
            </label>
            <div class="muted">Extract title, artist, album, year from files.</div>
          </div>
        </div>
        <div class="col">
          <div class="field">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="extract_thumbnails" style="width: auto;" {% if settings.get('extract_thumbnails', '1') == '1' %}checked{% endif %} />
              Extract Thumbnails (ffmpeg)
            </label>
            <div class="muted">Extract video thumbnails and album artwork.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Naming Templates</h2>
      <div class="row">
        {% for key, tpl in templates.items() %}
        <div class="col">
          <div class="field">
            <label>{{ key }}</label>
            <input data-template="{{ key }}" value="{{ tpl }}" />
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="muted">Templates are guidance only; you can edit per item in the queue.</div>
    </div>

    <div class="panel">
      <div class="actions">
        <button class="primary" id="save">Save Settings</button>
        <span class="muted" id="status"></span>
      </div>
    </div>
  </div>

  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    function csrfHeaders() {
      return csrfToken ? { 'X-CSRFToken': csrfToken } : {};
    }

    async function saveSettings() {
      const data = {
        browse_base: document.getElementById('browse_base').value,
        output_dir: document.getElementById('output_dir').value,
        release_group: document.getElementById('release_group').value,
        exclude_dirs: document.getElementById('exclude_dirs').value,
        extract_metadata: document.getElementById('extract_metadata').checked ? '1' : '0',
        extract_thumbnails: document.getElementById('extract_thumbnails').checked ? '1' : '0',
        enable_auto_upload: document.getElementById('enable_auto_upload').checked ? '1' : '0',
        auto_scan_interval: document.getElementById('auto_scan_interval').value,
        media_roots: [],
        templates: {},
      };

      document.querySelectorAll('#media-roots tbody tr').forEach(row => {
        const media_type = row.children[0].textContent.trim();
        const enabled = row.querySelector('input[data-field="enabled"]').checked;
        const auto_scan = row.querySelector('input[data-field="auto_scan"]').checked;
        const path = row.querySelector('input[data-field="path"]').value;
        const default_category = row.querySelector('select[data-field="default_category"]').value;
        data.media_roots.push({ media_type, enabled, auto_scan, path, default_category });
      });

      document.querySelectorAll('input[data-template]').forEach(input => {
        data.templates[input.dataset.template] = input.value;
      });

      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify(data),
      });
      const out = await res.json();
      const status = document.getElementById('status');
      status.textContent = out.success ? 'Saved' : (out.error || 'Save failed');
    }

    document.getElementById('save').onclick = saveSettings;

    // Theme toggle
    document.getElementById('theme-toggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
  </script>
</body>
</html>
