<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}" />
  <title>{{ app_name }} Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <style>
    /* Page-specific: checkbox label inline layout */
    .checkbox-field {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
    }

    .checkbox-field input[type="checkbox"] {
      width: auto;
      height: auto;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-brand">
      <a href="/" class="header-logo">{{ app_name }}</a>
      <span class="header-version">v{{ app_version }}</span>
    </div>
    <nav class="header-nav">
      <a href="/" class="nav-item">Dashboard</a>
      <a href="/browse" class="nav-item">Browse</a>
      <a href="/queue" class="nav-item">Queue</a>
      <a href="/history" class="nav-item">History</a>
      <a href="/settings" class="nav-item is-active">Settings</a>
    </nav>
    <button class="btn btn-ghost btn-sm" id="theme-toggle" title="Toggle light/dark mode"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
    <div class="header-status">
      <span class="status-dot status-dot-success" id="worker-status"></span>
      <span>Worker</span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container page">
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>

    <!-- General -->
    <div class="card mb-6">
      <h2 class="section-title">General</h2>
      <div class="grid grid-cols-2 gap-6">
        <div class="form-group">
          <label class="form-label">Browse Base</label>
          <input id="browse_base" value="{{ settings['browse_base'] }}" />
          <div class="form-hint">Default base path for your clean library.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Output Dir</label>
          <input id="output_dir" value="{{ settings['output_dir'] }}" />
          <div class="form-hint">Where .torrent, .nfo, and .xml sidecars are written.</div>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-6">
        <div class="form-group">
          <label class="form-label">Release Group</label>
          <input id="release_group" value="{{ settings.get('release_group', 'Torrup') }}" />
          <div class="form-hint">Your release group name for NFO files and naming.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Exclude Folders (comma-separated)</label>
          <input id="exclude_dirs" value="{{ settings['exclude_dirs'] }}" />
          <div class="form-hint">Folders containing these names are hidden from browse.</div>
        </div>
      </div>
    </div>

    <!-- Automation -->
    <div class="card mb-6">
      <h2 class="section-title">Automation (Beta)</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="test_mode" {% if settings.get('test_mode', '0') == '1' %}checked{% endif %} />
            Test Mode (Dry Run)
          </label>
          <div class="form-hint">Generate NFO + torrent but skip the actual upload to TorrentLeech.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="enable_auto_upload" {% if settings.get('enable_auto_upload', '0') == '1' %}checked{% endif %} />
            Enable Auto-Scan + Upload
          </label>
          <div class="form-hint">Automatically scan roots and queue items missing from TorrentLeech.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Scan Interval (minutes)</label>
          <input type="number" id="auto_scan_interval" value="{{ settings.get('auto_scan_interval', '60') }}" />
        </div>
      </div>
    </div>

    <!-- Media Roots -->
    <div class="card mb-6">
      <h2 class="section-title">Media Roots + Defaults</h2>
      <table class="table" id="media-roots">
        <thead>
          <tr>
            <th>Media Type</th>
            <th>Enabled</th>
            <th>Auto Scan</th>
            <th>Path</th>
            <th>Default Category</th>
          </tr>
        </thead>
        <tbody>
          {% for r in media_roots %}
          <tr>
            <td>{{ r.media_type }}</td>
            <td><input type="checkbox" data-field="enabled" {% if r.enabled %}checked{% endif %} style="width: auto; height: auto;" /></td>
            <td><input type="checkbox" data-field="auto_scan" {% if r.auto_scan %}checked{% endif %} style="width: auto; height: auto;" /></td>
            <td><input data-field="path" value="{{ r.path }}" /></td>
            <td>
              <select data-field="default_category">
                {% for opt in category_options[r.media_type] %}
                <option value="{{ opt.id }}" {% if opt.id == r.default_category %}selected{% endif %}>{{ opt.label }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-hint mt-2">Auto-scan only processes items in roots that are enabled and have "Auto Scan" checked.</div>
    </div>

    <!-- Metadata Extraction -->
    <div class="card mb-6">
      <h2 class="section-title">Metadata Extraction</h2>
      <div class="grid grid-cols-2 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="extract_metadata" {% if settings.get('extract_metadata', '1') == '1' %}checked{% endif %} />
            Extract Metadata (exiftool)
          </label>
          <div class="form-hint">Extract title, artist, album, year from files.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="extract_thumbnails" {% if settings.get('extract_thumbnails', '1') == '1' %}checked{% endif %} />
            Extract Thumbnails (ffmpeg)
          </label>
          <div class="form-hint">Extract video thumbnails and album artwork.</div>
        </div>
      </div>
    </div>

    <!-- qBitTorrent Integration -->
    <div class="card mb-6">
      <h2 class="section-title">qBitTorrent Integration</h2>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="qbt_enabled" {% if settings.get('qbt_enabled', '0') == '1' %}checked{% endif %} />
            Enable qBitTorrent
          </label>
          <div class="form-hint">Allow Torrup to communicate with qBitTorrent.</div>
        </div>
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="qbt_auto_add" {% if settings.get('qbt_auto_add', '0') == '1' %}checked{% endif %} />
            Auto-Add to qBT
          </label>
          <div class="form-hint">Automatically add torrent to qBitTorrent after successful upload.</div>
        </div>
        <div class="form-group">
          <label class="form-label">qBT Tag</label>
          <input id="qbt_tag" value="{{ settings.get('qbt_tag', 'Torrup') }}" />
        </div>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="checkbox-field">
            <input type="checkbox" id="qbt_auto_source" {% if settings.get('qbt_auto_source', '0') == '1' %}checked{% endif %} />
            Auto-Source from qBT
          </label>
          <div class="form-hint">Monitor qBitTorrent for completed downloads and add to queue.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Source Categories</label>
          <input id="qbt_source_categories" value="{{ settings.get('qbt_source_categories', 'music,movies,tv') }}" />
          <div class="form-hint">Comma-separated categories to monitor (e.g. music,movies,tv).</div>
        </div>
        <div class="form-group">
          <label class="form-label">Category Map</label>
          <input id="qbt_category_map" value="{{ settings.get('qbt_category_map', '') }}" placeholder="movies=Movies-HD,music=Music" />
          <div class="form-hint">Optional map: media_type=qBTCategory (CSV or JSON).</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <div class="form-group">
          <label class="form-label">qBT URL</label>
          <input id="qbt_url" value="{{ settings.get('qbt_url', 'http://localhost:8080') }}" />
        </div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="qbt_user" value="{{ settings.get('qbt_user', 'admin') }}" />
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="qbt_pass" value="{{ settings.get('qbt_pass', 'adminadmin') }}" />
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button class="btn btn-secondary btn-sm" id="test-qbt">Test Connection</button>
        <span class="text-muted text-sm" id="qbt-test-status"></span>
      </div>
    </div>

    <!-- Naming Templates -->
    <div class="card mb-6">
      <h2 class="section-title">Naming Templates</h2>
      <div class="grid grid-cols-2 gap-6">
        {% for key, tpl in templates.items() %}
        <div class="form-group">
          <label class="form-label">{{ key }}</label>
          <input data-template="{{ key }}" value="{{ tpl }}" />
        </div>
        {% endfor %}
      </div>
      <div class="form-hint">Templates are guidance only; you can edit per item in the queue.</div>
    </div>

    <!-- Save -->
    <div class="card mb-6">
      <div class="flex items-center gap-4">
        <button class="btn btn-primary btn-md" id="save">Save Settings</button>
        <span class="text-muted text-sm" id="status"></span>
      </div>
    </div>
  </main>

  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    function csrfHeaders() {
      return csrfToken ? { 'X-CSRFToken': csrfToken } : {};
    }

    async function saveSettings() {
      const data = {
        browse_base: document.getElementById('browse_base').value,
        output_dir: document.getElementById('output_dir').value,
        release_group: document.getElementById('release_group').value,
        exclude_dirs: document.getElementById('exclude_dirs').value,
        test_mode: document.getElementById('test_mode').checked ? '1' : '0',
        extract_metadata: document.getElementById('extract_metadata').checked ? '1' : '0',
        extract_thumbnails: document.getElementById('extract_thumbnails').checked ? '1' : '0',
        enable_auto_upload: document.getElementById('enable_auto_upload').checked ? '1' : '0',
        auto_scan_interval: document.getElementById('auto_scan_interval').value,
        qbt_enabled: document.getElementById('qbt_enabled').checked ? '1' : '0',
        qbt_auto_add: document.getElementById('qbt_auto_add').checked ? '1' : '0',
        qbt_tag: document.getElementById('qbt_tag').value,
        qbt_url: document.getElementById('qbt_url').value,
        qbt_user: document.getElementById('qbt_user').value,
        qbt_pass: document.getElementById('qbt_pass').value,
        qbt_auto_source: document.getElementById('qbt_auto_source').checked ? '1' : '0',
        qbt_source_categories: document.getElementById('qbt_source_categories').value,
        qbt_category_map: document.getElementById('qbt_category_map').value,
        media_roots: [],
        templates: {},
      };

      document.querySelectorAll('#media-roots tbody tr').forEach(row => {
        const media_type = row.children[0].textContent.trim();
        const enabled = row.querySelector('input[data-field="enabled"]').checked;
        const auto_scan = row.querySelector('input[data-field="auto_scan"]').checked;
        const path = row.querySelector('input[data-field="path"]').value;
        const default_category = row.querySelector('select[data-field="default_category"]').value;
        data.media_roots.push({ media_type, enabled, auto_scan, path, default_category });
      });

      document.querySelectorAll('input[data-template]').forEach(input => {
        data.templates[input.dataset.template] = input.value;
      });

      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify(data),
      });
      const out = await res.json();
      const status = document.getElementById('status');
      status.textContent = out.success ? 'Saved' : (out.error || 'Save failed');
    }

    document.getElementById('save').onclick = saveSettings;

    // Test qBT Connection
    document.getElementById('test-qbt').onclick = async () => {
      const status = document.getElementById('qbt-test-status');
      status.textContent = 'Testing...';
      try {
        const res = await fetch('/api/settings/qbt/test', {
          method: 'POST',
          headers: { ...csrfHeaders() }
        });
        const out = await res.json();
        status.textContent = out.success ? `Connected! qBT version: ${out.version}` : `Error: ${out.error}`;
      } catch (e) {
        status.textContent = `Error: ${e.message}`;
      }
    };

    // Theme toggle
    document.getElementById('theme-toggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
  </script>
</body>
</html>
