<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}" />
  <title>{{ app_name }}</title>
  <style>
    :root {
      --bg: #0f0f12; --bg-panel: #15151b; --bg-input: #1e1e27;
      --border: #242430; --border-light: #2d2d3a;
      --text: #e9e9ef; --text-muted: #9aa0a6; --text-heading: #c2c2d1;
      --accent: #8be9fd; --hover: #1c1c25;
      --status-queued: #2a2a36; --status-progress: #2a3642;
      --status-success: #1f4d36; --status-failed: #5a1e1e; --status-warn: #5a4b1e;
    }
    [data-theme="light"] {
      --bg: #f5f5f7; --bg-panel: #ffffff; --bg-input: #f0f0f2;
      --border: #d0d0d8; --border-light: #c5c5cd;
      --text: #1a1a1a; --text-muted: #666670; --text-heading: #333340;
      --accent: #0077cc; --hover: #e8e8ec;
      --status-queued: #e0e0e5; --status-progress: #d0e8f0;
      --status-success: #d0f0d8; --status-failed: #f8d0d0; --status-warn: #f0e8c8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Iosevka", "IBM Plex Sans", "Segoe UI", sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }
    a { color: var(--accent); text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.6rem; margin-bottom: 6px; }
    .sub { color: var(--text-muted); margin-bottom: 18px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .panel h2 { font-size: 1.05rem; margin-bottom: 12px; color: var(--text-heading); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 260px; }
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    select, input, button {
      background: var(--bg-input); color: var(--text); border: 1px solid var(--border-light); border-radius: 6px;
      padding: 8px 10px; font-size: 0.95rem;
    }
    button { cursor: pointer; font-weight: 600; }
    button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    button.ghost { background: transparent; }
    .file-list { max-height: 420px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
    .file-item { display: grid; grid-template-columns: 26px 1fr 120px; gap: 8px; padding: 8px 10px; border-bottom: 1px solid var(--border); align-items: center; }
    .file-item:hover { background: var(--hover); }
    .file-item .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .badge { padding: 2px 6px; border-radius: 6px; background: var(--status-queued); color: var(--text-heading); font-size: 0.75rem; }
    .queue-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .queue-table th, .queue-table td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
    .status { padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; }
    .status.queued { background: var(--status-queued); }
    .status.preparing { background: var(--status-progress); }
    .status.uploading { background: var(--status-progress); }
    .status.success { background: var(--status-success); }
    .status.failed { background: var(--status-failed); }
    .status.duplicate { background: var(--status-warn); }
    .muted { color: var(--text-muted); }
    .breadcrumb { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .breadcrumb button { padding: 4px 8px; font-size: 0.85rem; }
    .hint { color: var(--text-muted); font-size: 0.85rem; margin-top: 8px; }
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    .row-gap { margin-top: 8px; }
    .theme-toggle { cursor: pointer; background: none; border: none; padding: 4px 8px; display: flex; align-items: center; }
  </style>
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>{{ app_name }}</h1>
        <div class="sub">v{{ app_version }} â€” TorrentLeech batch uploader</div>
      </div>
      <div class="controls">
        <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
        <a href="/settings">Settings</a>
      </div>
    </div>

    <div class="panel">
      <h2>Browse Library</h2>
      <div class="controls row-gap">
        <label for="media-type" class="muted">Media type</label>
        <select id="media-type">
          {% for mt in media_types %}
          <option value="{{ mt }}">{{ mt }}</option>
          {% endfor %}
        </select>
        <button class="ghost" id="refresh">Refresh</button>
      </div>

      <div class="breadcrumb" id="breadcrumb"></div>
      <div class="file-list" id="file-list"></div>

      <div class="actions">
        <button class="primary" id="add-queue">Add Selected to Queue</button>
        <span class="muted" id="selected-count">0 selected</span>
      </div>
      <div class="hint">This view only shows enabled media roots and skips excluded folders from settings.</div>
    </div>

    <div class="panel">
      <h2>Queue</h2>
      <div class="actions">
        <button class="ghost" id="reload-queue">Reload</button>
      </div>
      <div class="row-gap"></div>
      <table class="queue-table" id="queue-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Release Name</th>
            <th>Category</th>
            <th>Tags</th>
            <th>Status</th>
            <th>Message</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const categoryOptions = {{ category_options | tojson }};
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    const mediaTypeSelect = document.getElementById('media-type');
    const fileList = document.getElementById('file-list');
    const breadcrumb = document.getElementById('breadcrumb');
    const selectedCount = document.getElementById('selected-count');
    const selected = new Map();

    let currentPath = '';
    let currentDefaultCategory = null;

    function csrfHeaders() {
      return csrfToken ? { 'X-CSRFToken': csrfToken } : {};
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function clearSelections() {
      selected.clear();
      selectedCount.textContent = '0 selected';
    }

    function updateSelectedCount() {
      selectedCount.textContent = `${selected.size} selected`;
    }

    function makeBreadcrumb(root, path, parent) {
      breadcrumb.innerHTML = '';
      const rootBtn = document.createElement('button');
      rootBtn.textContent = root.split('/').pop() || root;
      rootBtn.onclick = () => browse('');
      breadcrumb.appendChild(rootBtn);

      if (parent) {
        const upBtn = document.createElement('button');
        upBtn.textContent = '.. (up)';
        upBtn.onclick = () => browse(parent);
        breadcrumb.appendChild(upBtn);
      }

      const pathBadge = document.createElement('span');
      pathBadge.className = 'badge';
      pathBadge.textContent = path;
      breadcrumb.appendChild(pathBadge);
    }

    async function browse(path = '') {
      clearSelections();
      const mediaType = mediaTypeSelect.value;
      const response = await fetch(`/api/browse?media_type=${encodeURIComponent(mediaType)}&path=${encodeURIComponent(path)}`);
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        return;
      }
      currentPath = data.path;
      currentDefaultCategory = data.default_category;
      makeBreadcrumb(data.root || data.path, data.path, data.parent);
      fileList.innerHTML = '';
      data.items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'file-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.onchange = () => {
          if (checkbox.checked) {
            selected.set(item.path, item);
          } else {
            selected.delete(item.path);
          }
          updateSelectedCount();
        };
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.name;
        name.title = item.path;
        name.onclick = () => {
          if (item.is_dir) {
            browse(item.path);
          }
        };
        const size = document.createElement('div');
        size.className = 'muted';
        size.textContent = item.size;
        row.appendChild(checkbox);
        row.appendChild(name);
        row.appendChild(size);
        fileList.appendChild(row);
      });
    }

    async function addQueue() {
      if (!selected.size) return;
      const mediaType = mediaTypeSelect.value;
      const items = Array.from(selected.values()).map(item => {
        const defaultCategory = currentDefaultCategory || categoryOptions[mediaType][0].id;
        return {
          media_type: mediaType,
          path: item.path,
          category: defaultCategory,
        };
      });

      const res = await fetch('/api/queue/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.error || 'Failed to add queue');
        return;
      }
      clearSelections();
      await loadQueue();
    }

    function statusBadge(status) {
      return `<span class="status ${status}">${status}</span>`;
    }

    function categorySelect(mediaType, value) {
      const options = categoryOptions[mediaType]
        .map(o => `<option value="${o.id}" ${o.id === value ? 'selected' : ''}>${o.label}</option>`)
        .join('');
      return `<select data-field="category">${options}</select>`;
    }

    async function updateQueueRow(id, row) {
      const releaseName = row.querySelector('input[data-field="release_name"]').value;
      const category = row.querySelector('select[data-field="category"]').value;
      const tags = row.querySelector('input[data-field="tags"]').value;

      await fetch('/api/queue/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify({ id, release_name: releaseName, category, tags })
      });
      await loadQueue();
    }

    async function deleteQueueRow(id) {
      await fetch('/api/queue/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
        body: JSON.stringify({ id })
      });
      await loadQueue();
    }

    async function loadQueue() {
      const res = await fetch('/api/queue');
      const rows = await res.json();
      const tbody = document.querySelector('#queue-table tbody');
      tbody.innerHTML = '';
      rows.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(String(item.id))}</td>
          <td>${escapeHtml(item.media_type)}</td>
          <td><input data-field="release_name" value="${escapeHtml(item.release_name)}" /></td>
          <td>${categorySelect(item.media_type, item.category)}</td>
          <td><input data-field="tags" value="${escapeHtml(item.tags || '')}" placeholder="tag1,tag2" /></td>
          <td>${statusBadge(item.status)}</td>
          <td>${escapeHtml(item.message || '')}</td>
          <td>
            <button class="ghost" data-action="save">Save</button>
            <button class="ghost" data-action="delete">Delete</button>
          </td>
        `;
        tr.querySelector('button[data-action="save"]').onclick = () => updateQueueRow(item.id, tr);
        tr.querySelector('button[data-action="delete"]').onclick = () => deleteQueueRow(item.id);
        tbody.appendChild(tr);
      });
    }

    document.getElementById('refresh').onclick = () => browse(currentPath);
    document.getElementById('add-queue').onclick = addQueue;
    document.getElementById('reload-queue').onclick = loadQueue;

    mediaTypeSelect.onchange = () => browse('');

    browse('');
    loadQueue();

    // Theme toggle
    document.getElementById('theme-toggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    };
  </script>
</body>
</html>
